# 13-端到端完整教程

> 从零开始创建一个完整的鸭科夫Mod，包含一个可使用的治疗物品

---

## 第一步：创建项目结构

### 1.1 创建目录

```bash
mkdir MyHealingMod
cd MyHealingMod
mkdir Scripts
mkdir Release
mkdir Release/MyHealingMod
mkdir Release/MyHealingMod/Assets
```

### 1.2 创建项目文件

创建 `MyHealingMod.csproj`：

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>netstandard2.1</TargetFramework>
    <AssemblyName>MyHealingMod</AssemblyName>
    <RootNamespace>MyHealingMod</RootNamespace>
    <LangVersion>latest</LangVersion>
  </PropertyGroup>

  <!-- 根据你的系统修改路径 -->
  <PropertyGroup Condition="'$(OS)' == 'Windows_NT'">
    <DuckovPath>C:\Program Files\Steam\steamapps\common\Duckov\Duckov_Data\Managed</DuckovPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(OS)' != 'Windows_NT'">
    <DuckovPath>/Users/你的用户名/workspace/duckov/Managed</DuckovPath>
  </PropertyGroup>

  <ItemGroup>
    <Reference Include="UnityEngine.CoreModule">
      <HintPath>$(DuckovPath)/UnityEngine.CoreModule.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="TeamSoda.Duckov.Core">
      <HintPath>$(DuckovPath)/TeamSoda.Duckov.Core.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="ItemStatsSystem">
      <HintPath>$(DuckovPath)/ItemStatsSystem.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="Assembly-CSharp">
      <HintPath>$(DuckovPath)/Assembly-CSharp.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="SodaLocalization">
      <HintPath>$(DuckovPath)/SodaLocalization.dll</HintPath>
      <Private>False</Private>
    </Reference>
  </ItemGroup>
</Project>
```

---

## 第二步：编写Mod代码

### 2.1 创建主入口文件

创建 `Scripts/ModBehaviour.cs`：

```csharp
using UnityEngine;
using System;
using System.Reflection;
using System.Collections.Generic;
using Duckov;
using Duckov.Modding;
using ItemStatsSystem;
using SodaCraft.Localizations;

namespace MyHealingMod
{
    public class MyHealingModBehaviour : ModBehaviour
    {
        // ============ 配置 ============
        private const int ITEM_TYPE_ID = 990001;
        private const string ITEM_NAME_KEY = "MyHealingMod_Item_Name";
        private const string ITEM_DESC_KEY = "MyHealingMod_Item_Desc";

        // ============ 引用 ============
        private Item itemPrefab;
        private bool initialized = false;

        // ============ 生命周期 ============

        void Start()
        {
            Debug.Log("[MyHealingMod] 开始加载...");

            try
            {
                // 1. 设置本地化
                SetupLocalization();

                // 2. 创建物品
                CreateItemPrefab();

                // 3. 注册物品
                RegisterItem();

                // 4. 注册事件
                LevelManager.OnLevelInitialized += OnLevelReady;

                initialized = true;
                Debug.Log("[MyHealingMod] 加载完成!");
            }
            catch (Exception e)
            {
                Debug.LogError($"[MyHealingMod] 加载失败: {e.Message}\n{e.StackTrace}");
            }
        }

        void Update()
        {
            if (!initialized) return;

            // F9: 添加测试物品
            if (Input.GetKeyDown(KeyCode.F9))
            {
                GiveItemToPlayer();
            }
        }

        void OnDestroy()
        {
            Debug.Log("[MyHealingMod] 正在卸载...");

            // 取消事件
            LevelManager.OnLevelInitialized -= OnLevelReady;

            // 移除物品注册
            if (itemPrefab != null)
            {
                ItemAssetsCollection.RemoveDynamicEntry(itemPrefab);
                Destroy(itemPrefab.gameObject);
            }

            Debug.Log("[MyHealingMod] 卸载完成");
        }

        // ============ 本地化 ============

        private void SetupLocalization()
        {
            // 中文
            LocalizationManager.SetOverrideText(ITEM_NAME_KEY, "神奇药水");
            LocalizationManager.SetOverrideText(ITEM_DESC_KEY,
                "<color=#87CEEB>使用效果：</color>\n" +
                "• 恢复 50 点生命值\n" +
                "<color=#FFD700>「按F9获取测试物品」</color>");

            // 监听语言切换
            LocalizationManager.OnSetLanguage += OnLanguageChanged;
        }

        private void OnLanguageChanged(SystemLanguage language)
        {
            switch (language)
            {
                case SystemLanguage.English:
                    LocalizationManager.SetOverrideText(ITEM_NAME_KEY, "Magic Potion");
                    LocalizationManager.SetOverrideText(ITEM_DESC_KEY,
                        "<color=#87CEEB>Effect:</color>\n" +
                        "• Restore 50 HP\n" +
                        "<color=#FFD700>\"Press F9 for test item\"</color>");
                    break;
                default:
                    LocalizationManager.SetOverrideText(ITEM_NAME_KEY, "神奇药水");
                    LocalizationManager.SetOverrideText(ITEM_DESC_KEY,
                        "<color=#87CEEB>使用效果：</color>\n" +
                        "• 恢复 50 点生命值\n" +
                        "<color=#FFD700>「按F9获取测试物品」</color>");
                    break;
            }
        }

        // ============ 创建物品 ============

        private void CreateItemPrefab()
        {
            // 创建 GameObject
            GameObject obj = new GameObject("MyHealingPotion");
            DontDestroyOnLoad(obj);
            obj.SetActive(false);

            // 添加 Item 组件
            Item item = obj.AddComponent<Item>();

            // 设置属性（使用反射）
            SetFieldValue(item, "typeID", ITEM_TYPE_ID);
            SetFieldValue(item, "displayName", ITEM_NAME_KEY);
            SetFieldValue(item, "description", ITEM_DESC_KEY);
            SetFieldValue(item, "stackable", true);
            SetFieldValue(item, "maxStackCount", 10);
            SetFieldValue(item, "quality", 2);  // 精良品质
            SetFieldValue(item, "value", 500);
            SetFieldValue(item, "unitSelfWeight", 0.2f);

            // 添加使用行为
            HealingUseBehavior useBehavior = obj.AddComponent<HealingUseBehavior>();
            useBehavior.healValue = 50;

            // 配置 UsageUtilities
            SetupUsageUtilities(item, useBehavior);

            obj.SetActive(true);
            itemPrefab = item;

            Debug.Log($"[MyHealingMod] 物品创建完成: TypeID={ITEM_TYPE_ID}");
        }

        private void SetupUsageUtilities(Item item, UsageBehavior behavior)
        {
            // 获取或创建 UsageUtilities
            var usageUtilsField = typeof(Item).GetField("usageUtilities",
                BindingFlags.NonPublic | BindingFlags.Instance);

            UsageUtilities usageUtils = item.gameObject.GetComponent<UsageUtilities>();
            if (usageUtils == null)
            {
                usageUtils = item.gameObject.AddComponent<UsageUtilities>();
            }

            // 获取 behaviors 列表
            var behaviorsField = typeof(UsageUtilities).GetField("behaviors",
                BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance);

            var behaviors = behaviorsField?.GetValue(usageUtils) as List<UsageBehavior>;
            if (behaviors == null)
            {
                behaviors = new List<UsageBehavior>();
                behaviorsField?.SetValue(usageUtils, behaviors);
            }
            behaviors.Add(behavior);

            // 设置到 Item
            usageUtilsField?.SetValue(item, usageUtils);
        }

        // ============ 注册物品 ============

        private void RegisterItem()
        {
            if (itemPrefab == null) return;

            bool success = ItemAssetsCollection.AddDynamicEntry(itemPrefab);

            if (success)
            {
                Debug.Log($"[MyHealingMod] 物品注册成功: {ITEM_TYPE_ID}");
            }
            else
            {
                Debug.LogError($"[MyHealingMod] 物品注册失败: {ITEM_TYPE_ID}");
            }
        }

        // ============ 事件处理 ============

        private void OnLevelReady()
        {
            Debug.Log("[MyHealingMod] 关卡加载完成");
        }

        // ============ 调试功能 ============

        private void GiveItemToPlayer()
        {
            var character = CharacterMainControl.Main;
            if (character?.CharacterItem?.Inventory == null)
            {
                Debug.LogWarning("[MyHealingMod] 无法获取玩家背包");
                return;
            }

            if (itemPrefab == null)
            {
                Debug.LogWarning("[MyHealingMod] 物品预制体为空");
                return;
            }

            // 创建实例
            Item newItem = itemPrefab.CreateInstance();
            if (newItem == null)
            {
                Debug.LogWarning("[MyHealingMod] 无法创建物品实例");
                return;
            }

            // 添加到背包
            bool added = character.CharacterItem.Inventory.AddItem(newItem);

            if (added)
            {
                Debug.Log("[MyHealingMod] 物品已添加到背包");
                character.PopText("获得: 神奇药水");
            }
            else
            {
                Destroy(newItem.gameObject);
                Debug.LogWarning("[MyHealingMod] 背包已满");
            }
        }

        // ============ 工具方法 ============

        private void SetFieldValue(object obj, string fieldName, object value)
        {
            var type = obj.GetType();
            var field = type.GetField(fieldName,
                BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic);
            field?.SetValue(obj, value);
        }
    }
}
```

### 2.2 创建使用行为

创建 `Scripts/HealingUseBehavior.cs`：

```csharp
using UnityEngine;
using ItemStatsSystem;
using Duckov;

namespace MyHealingMod
{
    public class HealingUseBehavior : UsageBehavior
    {
        public int healValue = 50;

        public override DisplaySettingsData DisplaySettings => new DisplaySettingsData
        {
            display = true,
            description = $"恢复 {healValue} 点生命值"
        };

        public override bool CanBeUsed(Item item, object user)
        {
            CharacterMainControl character = user as CharacterMainControl;
            if (character == null) return false;

            // 满血时不能使用
            if (character.Health.CurrentHealth >= character.Health.MaxHealth)
            {
                return false;
            }

            return true;
        }

        protected override void OnUse(Item item, object user)
        {
            CharacterMainControl character = user as CharacterMainControl;
            if (character == null) return;

            // 计算实际治疗量
            float needed = character.Health.MaxHealth - character.Health.CurrentHealth;
            float actualHeal = Mathf.Min(healValue, needed);

            // 恢复生命值
            character.Health.AddHealth(actualHeal);

            // 显示提示
            character.PopText($"+{Mathf.RoundToInt(actualHeal)} HP");

            Debug.Log($"[MyHealingMod] 恢复了 {actualHeal} 点生命值");
        }
    }
}
```

---

## 第三步：编译项目

### 3.1 使用命令行编译

```bash
cd MyHealingMod
dotnet build -c Release
```

### 3.2 复制DLL到Release目录

编译成功后，将 `bin/Release/netstandard2.1/MyHealingMod.dll` 复制到 `Release/MyHealingMod/`

---

## 第四步：创建info.ini

在 `Release/MyHealingMod/` 目录创建 `info.ini`：

```ini
[mod]
name=MyHealingMod
version=1.0.0
author=你的名字
description=添加一个可以恢复50点生命值的神奇药水。按F9可以快速获取测试物品。
dll=MyHealingMod.dll
```

---

## 第五步：安装和测试

### 5.1 最终目录结构

```
Release/MyHealingMod/
├── MyHealingMod.dll    ← 编译的Mod代码
└── info.ini            ← Mod配置文件
```

### 5.2 安装Mod

将 `MyHealingMod` 文件夹复制到游戏Mods目录：

| 平台 | 路径 |
|------|------|
| Windows | `<游戏目录>\Duckov_Data\Mods\` |
| macOS | `Duckov.app/Contents/Mods/` |

### 5.3 测试

1. 启动游戏
2. 进入游戏关卡
3. 按 **F9** 获取测试物品
4. 在背包中找到"神奇药水"
5. 受伤后使用物品，验证治疗效果

### 5.4 查看日志

如果有问题，查看日志文件：

| 平台 | 路径 |
|------|------|
| Windows | `%USERPROFILE%\AppData\LocalLow\TeamSoda\Escape from Duckov\Player.log` |
| macOS | `~/Library/Logs/TeamSoda/Escape from Duckov/Player.log` |

搜索 `[MyHealingMod]` 查看Mod输出。

---

## 第六步（可选）：添加AssetBundle

如果需要自定义图标或模型：

### 6.1 创建Unity项目

参考 [10-Unity项目配置指南](10-Unity项目配置指南.md)

### 6.2 制作图标

1. 创建 128x128 PNG 图标
2. 导入Unity，设置为 Sprite
3. 设置 AssetBundle 名称为 `myhealing_assets`
4. 构建 AssetBundle

### 6.3 修改代码加载图标

```csharp
private void LoadAssetBundle()
{
    string modPath = System.IO.Path.GetDirectoryName(info.dllPath);
    string bundlePath = System.IO.Path.Combine(modPath, "Assets", "myhealing_assets");

    if (!System.IO.File.Exists(bundlePath)) return;

    AssetBundle bundle = AssetBundle.LoadFromFile(bundlePath);
    if (bundle != null)
    {
        Sprite icon = bundle.LoadAsset<Sprite>("PotionIcon");
        if (icon != null)
        {
            SetFieldValue(itemPrefab, "icon", icon);
        }
    }
}
```

### 6.4 更新Release目录

```
Release/MyHealingMod/
├── MyHealingMod.dll
├── info.ini
└── Assets/
    └── myhealing_assets    ← AssetBundle文件
```

---

## 完整开发检查清单

```
□ 项目配置
  □ .csproj 目标框架为 netstandard2.1
  □ DLL 引用路径正确
  □ 项目可以成功编译

□ 代码检查
  □ 继承自 ModBehaviour
  □ Start() 中初始化所有内容
  □ OnDestroy() 中清理所有资源和事件
  □ TypeID 使用 990000+ 范围
  □ 本地化文本已设置

□ 物品检查
  □ Item 组件属性已设置
  □ UsageBehavior 已添加
  □ UsageUtilities 已配置
  □ 已注册到 ItemAssetsCollection

□ 部署检查
  □ DLL 已复制到 Release 目录
  □ info.ini 配置正确
  □ 整个文件夹复制到游戏 Mods 目录

□ 测试检查
  □ 游戏能够加载 Mod（查看日志）
  □ 物品能够正常获取（F9）
  □ 物品能够正常使用
  □ 卸载 Mod 后游戏正常
```

---

## 常见问题

### Mod不加载

1. 检查 info.ini 中的 dll 字段是否正确
2. 检查 DLL 是否在正确位置
3. 查看 Player.log 中的错误信息

### 物品无法使用

1. 检查 UsageUtilities 是否配置
2. 检查 behaviors 列表是否包含 UsageBehavior
3. 检查 CanBeUsed() 返回值

### 游戏崩溃

1. 查看 Player.log 中的异常信息
2. 检查是否有空引用
3. 确保 OnDestroy() 中正确清理

---

## 下一步

完成基础教程后，可以学习更多高级功能：

- [03-物品使用与技能](03-物品使用与技能.md) - 学习技能系统
- [04-效果系统](04-效果系统.md) - 学习被动效果
- [05-战斗与武器系统](05-战斗与武器系统.md) - 学习创建武器
- [06-商店与箱子系统](06-商店与箱子系统.md) - 学习注册到商店
