# 06-商店与箱子系统

## StockShopDatabase 商店数据库

### 获取商店数据库

```csharp
// 获取商店数据库实例
StockShopDatabase shopDatabase = StockShopDatabase.Instance;

// 或通过 GameplayDataSettings 获取
var shopDB = Duckov.Utilities.GameplayDataSettings.StockShopDatabase;
```

### 商店数据结构

```csharp
public class StockShopDatabase : ScriptableObject
{
    public List<StockShopEntry> entries;  // 商店条目列表

    // 根据 TypeID 获取条目
    public StockShopEntry GetEntry(int typeId);

    // 添加动态条目（Mod使用）
    public static void AddDynamicEntry(StockShopEntry entry);

    // 移除动态条目
    public static void RemoveDynamicEntry(int typeId);
}
```

### StockShopEntry 条目结构

```csharp
public class StockShopEntry
{
    public int typeId;              // 物品 TypeID
    public int basePrice;           // 基础价格
    public int minStock;            // 最小库存
    public int maxStock;            // 最大库存
    public float restockChance;     // 补货概率
    public string[] shopTags;       // 商店标签（哪些商店出售）
}
```

---

## 注册物品到商店

### 基本注册

```csharp
using Duckov;
using ItemStatsSystem;

private void RegisterToShop(Item itemPrefab, int price)
{
    if (itemPrefab == null) return;

    // 创建商店条目
    StockShopEntry entry = new StockShopEntry
    {
        typeId = itemPrefab.TypeID,
        basePrice = price,
        minStock = 1,
        maxStock = 5,
        restockChance = 0.5f,
        shopTags = new string[] { "General", "Weapon" }  // 出现在哪些商店
    };

    // 注册到商店数据库
    StockShopDatabase.AddDynamicEntry(entry);

    Debug.Log($"[Mod] 物品已注册到商店: TypeID={itemPrefab.TypeID}, 价格={price}");
}
```

### 移除商店注册

```csharp
void OnDestroy()
{
    // Mod卸载时移除商店条目
    if (itemPrefab != null)
    {
        StockShopDatabase.RemoveDynamicEntry(itemPrefab.TypeID);
    }
}
```

---

## 商店标签说明

| 标签 | 说明 |
|------|------|
| General | 通用商店 |
| Weapon | 武器商店 |
| Armor | 护甲商店 |
| Medical | 医疗商店 |
| Food | 食品商店 |
| Ammo | 弹药商店 |
| Attachment | 配件商店 |

---

## LootBox 箱子系统

### 箱子数据结构

```csharp
public class LootBoxDatabase
{
    public List<LootBoxEntry> entries;
}

public class LootBoxEntry
{
    public string boxId;                    // 箱子ID
    public List<LootItem> possibleItems;    // 可能的物品列表
}

public class LootItem
{
    public int typeId;          // 物品 TypeID
    public float weight;        // 权重（出现概率）
    public int minCount;        // 最小数量
    public int maxCount;        // 最大数量
}
```

### 注入物品到箱子

```csharp
using Duckov;
using System.Reflection;

private void InjectToLootBox(Item itemPrefab, string boxId, float weight)
{
    // 获取 LootBoxDatabase
    var lootBoxDB = GetLootBoxDatabase();
    if (lootBoxDB == null) return;

    // 查找目标箱子
    var entriesField = lootBoxDB.GetType().GetField("entries",
        BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance);
    var entries = entriesField?.GetValue(lootBoxDB) as IList;

    if (entries == null) return;

    foreach (var entry in entries)
    {
        var idField = entry.GetType().GetField("boxId");
        string currentId = idField?.GetValue(entry) as string;

        if (currentId == boxId)
        {
            // 找到目标箱子，添加物品
            var itemsField = entry.GetType().GetField("possibleItems");
            var items = itemsField?.GetValue(entry) as IList;

            if (items != null)
            {
                // 创建 LootItem
                var lootItem = CreateLootItem(itemPrefab.TypeID, weight, 1, 1);
                items.Add(lootItem);

                Debug.Log($"[Mod] 物品注入到箱子 {boxId}: TypeID={itemPrefab.TypeID}");
            }
            break;
        }
    }
}

private object CreateLootItem(int typeId, float weight, int minCount, int maxCount)
{
    // 使用反射创建 LootItem
    var lootItemType = Type.GetType("Duckov.LootItem, Assembly-CSharp");
    if (lootItemType == null) return null;

    var lootItem = Activator.CreateInstance(lootItemType);

    var typeIdField = lootItemType.GetField("typeId");
    var weightField = lootItemType.GetField("weight");
    var minCountField = lootItemType.GetField("minCount");
    var maxCountField = lootItemType.GetField("maxCount");

    typeIdField?.SetValue(lootItem, typeId);
    weightField?.SetValue(lootItem, weight);
    minCountField?.SetValue(lootItem, minCount);
    maxCountField?.SetValue(lootItem, maxCount);

    return lootItem;
}
```

---

## 常用箱子 ID

| 箱子ID | 说明 |
|--------|------|
| CommonLoot | 普通战利品箱 |
| RareLoot | 稀有战利品箱 |
| WeaponCrate | 武器箱 |
| MedicalSupply | 医疗补给箱 |
| AmmoBox | 弹药箱 |

---

## 商店事件监听

```csharp
// 监听购买事件
StockShop.OnItemPurchased += OnItemPurchased;

// 监听出售事件
StockShop.OnItemSold += OnItemSold;

void OnItemPurchased(Item item, int price)
{
    Debug.Log($"购买物品: {item.DisplayName}, 价格: {price}");
}

void OnItemSold(Item item, int price)
{
    Debug.Log($"出售物品: {item.DisplayName}, 价格: {price}");
}

void OnDestroy()
{
    StockShop.OnItemPurchased -= OnItemPurchased;
    StockShop.OnItemSold -= OnItemSold;
}
```

---

## 动态调整价格

```csharp
/// <summary>
/// 根据稀有度调整物品价格
/// </summary>
private int CalculatePrice(Item item, int basePrice)
{
    float multiplier = 1f;

    switch (item.Quality)
    {
        case 0: multiplier = 0.5f;  break;  // 普通
        case 1: multiplier = 0.8f;  break;  // 优秀
        case 2: multiplier = 1.0f;  break;  // 精良
        case 3: multiplier = 1.5f;  break;  // 稀有
        case 4: multiplier = 2.5f;  break;  // 史诗
        case 5: multiplier = 5.0f;  break;  // 传说
    }

    return Mathf.RoundToInt(basePrice * multiplier);
}
```

---

## 完整商店注册示例

```csharp
using UnityEngine;
using Duckov;
using Duckov.Modding;
using ItemStatsSystem;

namespace MyMod
{
    public class ShopRegistration : ModBehaviour
    {
        private Item weaponPrefab;
        private Item consumablePrefab;
        private bool registered = false;

        void Start()
        {
            // 等待物品创建完成后注册
            RegisterItemsToShop();
        }

        private void RegisterItemsToShop()
        {
            // 注册武器到武器商店
            if (weaponPrefab != null)
            {
                StockShopEntry weaponEntry = new StockShopEntry
                {
                    typeId = weaponPrefab.TypeID,
                    basePrice = 5000,
                    minStock = 1,
                    maxStock = 2,
                    restockChance = 0.3f,
                    shopTags = new string[] { "Weapon" }
                };
                StockShopDatabase.AddDynamicEntry(weaponEntry);
            }

            // 注册消耗品到医疗商店和通用商店
            if (consumablePrefab != null)
            {
                StockShopEntry consumableEntry = new StockShopEntry
                {
                    typeId = consumablePrefab.TypeID,
                    basePrice = 500,
                    minStock = 3,
                    maxStock = 10,
                    restockChance = 0.8f,
                    shopTags = new string[] { "General", "Medical" }
                };
                StockShopDatabase.AddDynamicEntry(consumableEntry);
            }

            registered = true;
            Debug.Log("[MyMod] 物品已注册到商店");
        }

        void OnDestroy()
        {
            if (registered)
            {
                if (weaponPrefab != null)
                    StockShopDatabase.RemoveDynamicEntry(weaponPrefab.TypeID);
                if (consumablePrefab != null)
                    StockShopDatabase.RemoveDynamicEntry(consumablePrefab.TypeID);

                Debug.Log("[MyMod] 商店条目已清理");
            }
        }
    }
}
```

---

## 概率配置说明

### restockChance 补货概率

```
0.0 - 永不补货
0.3 - 30% 概率补货（稀有物品）
0.5 - 50% 概率补货（普通物品）
0.8 - 80% 概率补货（常见物品）
1.0 - 必定补货
```

### LootBox weight 权重

```
权重越高，出现概率越大
例如：物品A权重10，物品B权重5
物品A出现概率 = 10/(10+5) = 66.7%
物品B出现概率 = 5/(10+5) = 33.3%
```

---

## 常见问题

### 物品不出现在商店

1. 检查 `shopTags` 是否正确
2. 确认 `StockShopDatabase.AddDynamicEntry` 返回成功
3. 检查 `minStock` 和 `maxStock` 是否 > 0

### 箱子不掉落物品

1. 检查 `boxId` 是否正确
2. 确认 `weight` > 0
3. 检查物品 TypeID 是否已注册到 `ItemAssetsCollection`

### 价格显示异常

1. 确认 `basePrice` 是合理的正整数
2. 检查是否有其他 Mod 修改了价格计算
