# 02-物品系统基础

## Item 核心属性

```csharp
public class Item : MonoBehaviour
{
    // ========== 标识属性 ==========
    public int TypeID;              // 物品类型ID（必须唯一）
    public string displayName;      // 显示名称（本地化键）
    public string description;      // 描述（本地化键）
    public Sprite icon;             // 图标

    // ========== 堆叠属性 ==========
    public bool stackable;          // 是否可堆叠
    public int maxStackCount;       // 最大堆叠数量
    public int StackCount;          // 当前堆叠数量

    // ========== 价值属性 ==========
    public int quality;             // 品质（0-5）
    public int value;               // 基础价值

    // ========== 组件引用 ==========
    public ItemAgentUtilities AgentUtilities;  // 手持代理工具
    public List<Effect> Effects;               // 效果列表
}
```

---

## TypeID 规范

| 范围 | 用途 |
|------|------|
| 1 - 9999 | 官方物品 |
| 10000 - 99999 | 预留 |
| 990000+ | Mod 物品（推荐） |

**重要**: TypeID 必须全局唯一，冲突会导致物品无法正常工作。

---

## 创建物品预制体

### 程序化创建（推荐用于简单物品）

```csharp
using UnityEngine;
using ItemStatsSystem;
using System.Reflection;

private Item CreateItemPrefab(string name, int typeId, string nameKey,
    string descKey, Sprite icon)
{
    // 1. 创建 GameObject
    GameObject obj = new GameObject(name);
    DontDestroyOnLoad(obj);    // 防止场景切换时销毁
    obj.SetActive(false);       // 预制体不激活

    // 2. 添加 Item 组件
    Item item = obj.AddComponent<Item>();

    // 3. 使用反射设置属性（Item 字段是私有的）
    SetFieldValue(item, "typeID", typeId);
    SetFieldValue(item, "displayName", nameKey);
    SetFieldValue(item, "description", descKey);
    if (icon != null) SetFieldValue(item, "icon", icon);

    // 4. 设置其他属性
    SetFieldValue(item, "stackable", true);
    SetFieldValue(item, "maxStackCount", 5);
    SetFieldValue(item, "quality", 3);      // 稀有
    SetFieldValue(item, "value", 5000);

    return item;
}

// 反射工具方法
private void SetFieldValue(object obj, string fieldName, object value)
{
    var type = obj.GetType();
    var field = type.GetField(fieldName,
        BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic);
    field?.SetValue(obj, value);
}
```

### 从 AssetBundle 加载（推荐用于复杂物品）

```csharp
private Item LoadItemFromBundle(AssetBundle bundle, string prefabName)
{
    // 加载预制体
    Item itemPrefab = bundle.LoadAsset<Item>(prefabName);

    if (itemPrefab != null)
    {
        // 可以在这里修改属性
        SetFieldValue(itemPrefab, "displayName", "MyItem_Name");
        SetFieldValue(itemPrefab, "description", "MyItem_Desc");
    }

    return itemPrefab;
}
```

---

## 物品注册

### 注册到游戏系统

```csharp
using ItemStatsSystem;

private void RegisterItem(Item itemPrefab)
{
    if (itemPrefab == null) return;

    // 注册到动态物品系统
    bool success = ItemAssetsCollection.AddDynamicEntry(itemPrefab);

    if (success)
    {
        Debug.Log($"[Mod] 物品注册成功: {itemPrefab.TypeID}");
    }
    else
    {
        Debug.LogError($"[Mod] 物品注册失败: {itemPrefab.TypeID}（可能TypeID冲突）");
    }
}
```

### 移除注册

```csharp
void OnDestroy()
{
    if (itemPrefab != null)
    {
        ItemAssetsCollection.RemoveDynamicEntry(itemPrefab);
        Destroy(itemPrefab.gameObject);
    }
}
```

---

## 物品实例化

### CreateInstance 方法

```csharp
/// <summary>
/// 从预制体创建物品实例
/// </summary>
public static Item CreateItemInstance(Item prefab)
{
    if (prefab == null) return null;

    // 使用 Item.CreateInstance()
    Item instance = prefab.CreateInstance();

    // 初始化（修复可能的问题）
    if (instance != null)
    {
        InitializeModItem(instance);
    }

    return instance;
}

/// <summary>
/// 初始化 Mod 创建的物品
/// </summary>
private static void InitializeModItem(Item item)
{
    if (item == null) return;

    // 确保物品已初始化
    if (!item.GetBool("initialized"))
    {
        item.Initialize();
    }

    // 初始化 AgentUtilities
    var agentUtils = item.AgentUtilities;
    if (agentUtils != null)
    {
        agentUtils.Initialize(item);
    }
}
```

### 添加物品到背包

```csharp
/// <summary>
/// 添加物品到玩家背包
/// </summary>
private bool TryAddItemToPlayer(Item prefab)
{
    var character = CharacterMainControl.Main;
    if (character?.CharacterItem?.Inventory == null)
    {
        Debug.LogWarning("[Mod] 无法获取玩家背包");
        return false;
    }

    // 创建实例
    Item newItem = prefab.CreateInstance();
    if (newItem == null) return false;

    // 添加到背包
    bool success = character.CharacterItem.Inventory.AddItem(newItem);

    if (!success)
    {
        // 添加失败，清理
        Destroy(newItem.gameObject);
    }

    return success;
}
```

---

## 本地化

### 设置本地化文本

```csharp
using SodaCraft.Localizations;

private void SetupLocalization()
{
    // 设置中文文本
    LocalizationManager.SetOverrideText("MyItem_Name", "物品名称");
    LocalizationManager.SetOverrideText("MyItem_Desc", "物品描述文本");

    // 监听语言切换事件
    LocalizationManager.OnSetLanguage += OnLanguageChanged;
}

private void OnLanguageChanged(SystemLanguage language)
{
    switch (language)
    {
        case SystemLanguage.English:
            LocalizationManager.SetOverrideText("MyItem_Name", "Item Name");
            LocalizationManager.SetOverrideText("MyItem_Desc", "Item description");
            break;
        default: // 中文
            LocalizationManager.SetOverrideText("MyItem_Name", "物品名称");
            LocalizationManager.SetOverrideText("MyItem_Desc", "物品描述文本");
            break;
    }
}

void OnDestroy()
{
    // 取消监听
    LocalizationManager.OnSetLanguage -= OnLanguageChanged;
}
```

### 富文本格式

```csharp
// 支持的富文本标签
string description =
    "<color=#87CEEB>特殊能力：</color>\n" +      // 颜色
    "• 恢复 50 点生命值\n" +
    "• <b>持续恢复</b> 5秒\n" +                   // 粗体
    "<color=#FFD700>「传说物品」</color>";        // 金色
```

---

## 品质等级

| 品质值 | 名称 | 颜色 |
|--------|------|------|
| 0 | 普通 | 白色 |
| 1 | 优秀 | 绿色 |
| 2 | 精良 | 蓝色 |
| 3 | 稀有 | 紫色 |
| 4 | 史诗 | 橙色 |
| 5 | 传说 | 金色 |

---

## Stats 属性系统

### 定义 Stats

物品的统计属性通过 `Item.Stats` 配置（在 Unity Prefab 中设置）。

### 读取 Stats

```csharp
// 直接读取（字符串）
float damage = item.GetStatValue("Damage");

// 使用 Hash 缓存（性能优化）
private static readonly int DamageHash = "Damage".GetHashCode();
float damage = item.GetStatValue(DamageHash);
```

### Stats Hash 缓存模式

```csharp
public class WeaponStats : MonoBehaviour
{
    // 静态 Hash 缓存（编译时计算）
    private static readonly int DamageHash = "Damage".GetHashCode();
    private static readonly int CritRateHash = "CritRate".GetHashCode();
    private static readonly int AttackRangeHash = "AttackRange".GetHashCode();
    private static readonly int StaminaCostHash = "StaminaCost".GetHashCode();

    private Item item;

    // 属性访问器
    public float Damage => item != null ? item.GetStatValue(DamageHash) : 50f;
    public float CritRate => item != null ? item.GetStatValue(CritRateHash) : 0.05f;
    public float AttackRange => item != null ? item.GetStatValue(AttackRangeHash) : 2f;
    public float StaminaCost => item != null ? item.GetStatValue(StaminaCostHash) : 5f;

    void Start()
    {
        item = GetComponent<Item>();
    }
}
```

### 常用 Stats 属性

| 属性名 | 说明 | 典型值 |
|--------|------|--------|
| Damage | 伤害 | 10-100 |
| CritRate | 暴击率 | 0.05-0.3 |
| CritDamageFactor | 暴击伤害倍率 | 1.5-2.5 |
| ArmorPiercing | 护甲穿透 | 0-50 |
| AttackSpeed | 攻击速度 | 0.5-2.0 |
| AttackRange | 攻击范围 | 1-5 |
| StaminaCost | 体力消耗 | 5-20 |
| BleedChance | 流血几率 | 0-0.5 |

---

## ItemAgentUtilities

`ItemAgentUtilities` 管理物品的视觉代理（如手持显示）。

### 配置手持代理

```csharp
private void ConfigureAgentUtilities(Item item)
{
    var agentUtils = item.AgentUtilities;
    if (agentUtils == null) return;

    // 获取手持代理预制体
    var handheldPrefab = Duckov.Utilities.GameplayDataSettings.Prefabs.HandheldAgentPrefab;

    // 使用反射添加代理
    var agentsField = typeof(ItemAgentUtilities).GetField("agents",
        BindingFlags.NonPublic | BindingFlags.Instance);
    var agents = agentsField?.GetValue(agentUtils) as System.Collections.IList;

    if (agents == null)
    {
        // 创建 agents 列表
        var agentKeyPairType = typeof(ItemAgentUtilities).GetNestedType("AgentKeyPair",
            BindingFlags.NonPublic | BindingFlags.Instance);
        var listType = typeof(List<>).MakeGenericType(agentKeyPairType);
        agents = (System.Collections.IList)Activator.CreateInstance(listType);
        agentsField?.SetValue(agentUtils, agents);
    }

    // 检查是否已有 Handheld
    bool hasHandheld = false;
    foreach (var agent in agents)
    {
        var keyField = agent.GetType().GetField("key");
        if (keyField?.GetValue(agent)?.ToString() == "Handheld")
        {
            hasHandheld = true;
            break;
        }
    }

    // 添加 Handheld 代理
    if (!hasHandheld && handheldPrefab != null)
    {
        var agentKeyPairType = typeof(ItemAgentUtilities).GetNestedType("AgentKeyPair",
            BindingFlags.NonPublic | BindingFlags.Instance);
        var pair = Activator.CreateInstance(agentKeyPairType);

        var keyField = agentKeyPairType.GetField("key");
        var prefabField = agentKeyPairType.GetField("agentPrefab");

        keyField.SetValue(pair, "Handheld");
        prefabField.SetValue(pair, handheldPrefab);

        agents.Add(pair);
    }
}
```

### AgentUtilities 修复组件

```csharp
/// <summary>
/// 自动修复物品的 AgentUtilities
/// 添加到物品预制体上
/// </summary>
public class AgentUtilitiesFixer : MonoBehaviour
{
    private bool initialized = false;

    void OnEnable()
    {
        if (initialized) return;

        var item = GetComponent<Item>();
        if (item == null) return;

        try
        {
            // 确保物品已初始化
            if (!item.GetBool("initialized"))
            {
                item.Initialize();
            }

            // 初始化 AgentUtilities
            var agentUtils = item.AgentUtilities;
            if (agentUtils != null)
            {
                ConfigureAgentUtilities(item);
            }

            initialized = true;
        }
        catch (Exception e)
        {
            Debug.LogWarning($"AgentUtilitiesFixer 失败: {e.Message}");
        }
    }
}
```

---

## 多物品管理

### 使用 Dictionary 管理预制体

```csharp
public class MyModBehaviour : ModBehaviour
{
    // 预制体注册表
    private Dictionary<int, Item> prefabRegistry = new Dictionary<int, Item>();

    // TypeID 常量
    private const int ITEM1_TYPE_ID = 990001;
    private const int ITEM2_TYPE_ID = 990002;
    private const int ITEM3_TYPE_ID = 990003;

    void Start()
    {
        // 创建物品
        var item1 = CreateItemPrefab("Item1", ITEM1_TYPE_ID, ...);
        var item2 = CreateItemPrefab("Item2", ITEM2_TYPE_ID, ...);
        var item3 = CreateItemPrefab("Item3", ITEM3_TYPE_ID, ...);

        // 注册到字典
        prefabRegistry[ITEM1_TYPE_ID] = item1;
        prefabRegistry[ITEM2_TYPE_ID] = item2;
        prefabRegistry[ITEM3_TYPE_ID] = item3;

        // 注册到游戏
        foreach (var kvp in prefabRegistry)
        {
            ItemAssetsCollection.AddDynamicEntry(kvp.Value);
        }
    }

    void OnDestroy()
    {
        // 清理所有物品
        foreach (var kvp in prefabRegistry)
        {
            if (kvp.Value != null)
            {
                ItemAssetsCollection.RemoveDynamicEntry(kvp.Value);
                Destroy(kvp.Value.gameObject);
            }
        }
        prefabRegistry.Clear();
    }

    // 根据 TypeID 获取预制体
    public Item GetPrefab(int typeId)
    {
        return prefabRegistry.TryGetValue(typeId, out var prefab) ? prefab : null;
    }
}
```

---

## 常见问题

### 物品图标不显示

1. 确认 Sprite 正确加载
2. 检查本地化键是否设置
3. 确认物品已注册

### 物品无法拾取/使用

1. 检查 ItemAgentUtilities 配置
2. 确认 UsageBehavior 组件（如需要）
3. 检查 CanBeUsed() 返回值

### 堆叠不正常

1. 确认 stackable = true
2. 检查 maxStackCount 值
3. 确认 TypeID 一致
