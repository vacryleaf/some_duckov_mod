# 09-完整模板与检查清单

## 完整 ModBehaviour 模板

```csharp
using UnityEngine;
using System;
using System.IO;
using System.Reflection;
using System.Collections.Generic;
using Duckov;
using Duckov.Modding;
using ItemStatsSystem;
using SodaCraft.Localizations;

namespace MyMod
{
    public class MyModBehaviour : ModBehaviour
    {
        // ============ 配置常量 ============
        private const int ITEM_TYPE_ID = 990001;
        private const string ITEM_NAME_KEY = "MyMod_Item_Name";
        private const string ITEM_DESC_KEY = "MyMod_Item_Desc";

        // ============ 资源引用 ============
        private AssetBundle assetBundle;
        private Item itemPrefab;
        private Sprite itemIcon;

        // ============ 状态标记 ============
        private bool initialized = false;
        private bool eventsRegistered = false;
        private CharacterMainControl player;

        // ============ 生命周期 ============

        void Start()
        {
            Debug.Log("[MyMod] 开始加载...");

            try
            {
                // 1. 加载资源
                LoadAssetBundle();

                // 2. 创建物品
                CreateItemPrefab();

                // 3. 注册物品
                RegisterItem();

                // 4. 设置本地化
                SetupLocalization();

                // 5. 注册全局事件
                RegisterGlobalEvents();

                initialized = true;
                Debug.Log("[MyMod] 加载完成!");
            }
            catch (Exception e)
            {
                Debug.LogError($"[MyMod] 加载失败: {e.Message}\n{e.StackTrace}");
            }
        }

        void Update()
        {
            if (!initialized) return;

            // 调试快捷键
            HandleDebugKeys();
        }

        void OnDestroy()
        {
            Debug.Log("[MyMod] 正在卸载...");

            // 1. 取消事件注册
            UnregisterEvents();

            // 2. 移除物品注册
            if (itemPrefab != null)
            {
                ItemAssetsCollection.RemoveDynamicEntry(itemPrefab);
                Destroy(itemPrefab.gameObject);
            }

            // 3. 卸载 AssetBundle
            if (assetBundle != null)
            {
                assetBundle.Unload(true);
            }

            Debug.Log("[MyMod] 卸载完成");
        }

        // ============ 资源加载 ============

        private void LoadAssetBundle()
        {
            string modFolder = GetModFolderPath();
            string bundlePath = Path.Combine(modFolder, "Assets", "mymod_assets");

            if (!File.Exists(bundlePath))
            {
                Debug.LogWarning($"[MyMod] AssetBundle 不存在: {bundlePath}");
                return;
            }

            assetBundle = AssetBundle.LoadFromFile(bundlePath);

            if (assetBundle != null)
            {
                // 加载图标
                itemIcon = LoadIconFromBundle("MyItemIcon");
                Debug.Log("[MyMod] AssetBundle 加载成功");
            }
        }

        private Sprite LoadIconFromBundle(string iconName)
        {
            if (assetBundle == null) return null;

            Sprite icon = assetBundle.LoadAsset<Sprite>(iconName);
            if (icon != null) return icon;

            Texture2D tex = assetBundle.LoadAsset<Texture2D>(iconName);
            if (tex != null)
            {
                return Sprite.Create(tex,
                    new Rect(0, 0, tex.width, tex.height),
                    new Vector2(0.5f, 0.5f));
            }

            return null;
        }

        private string GetModFolderPath()
        {
            if (info != null && !string.IsNullOrEmpty(info.dllPath))
            {
                return Path.GetDirectoryName(info.dllPath);
            }

            string assemblyPath = GetType().Assembly.Location;
            if (!string.IsNullOrEmpty(assemblyPath))
            {
                return Path.GetDirectoryName(assemblyPath);
            }

            return string.Empty;
        }

        // ============ 物品创建 ============

        private void CreateItemPrefab()
        {
            GameObject obj = new GameObject("MyModItem");
            DontDestroyOnLoad(obj);
            obj.SetActive(false);

            Item item = obj.AddComponent<Item>();

            // 使用反射设置私有字段
            SetFieldValue(item, "typeID", ITEM_TYPE_ID);
            SetFieldValue(item, "displayName", ITEM_NAME_KEY);
            SetFieldValue(item, "description", ITEM_DESC_KEY);
            SetFieldValue(item, "stackable", true);
            SetFieldValue(item, "maxStackCount", 5);
            SetFieldValue(item, "quality", 3);  // 稀有
            SetFieldValue(item, "value", 5000);

            if (itemIcon != null)
            {
                SetFieldValue(item, "icon", itemIcon);
            }

            itemPrefab = item;
            Debug.Log($"[MyMod] 物品预制体创建完成: TypeID={ITEM_TYPE_ID}");
        }

        // ============ 物品注册 ============

        private void RegisterItem()
        {
            if (itemPrefab == null) return;

            bool success = ItemAssetsCollection.AddDynamicEntry(itemPrefab);

            if (success)
            {
                Debug.Log($"[MyMod] 物品注册成功: {ITEM_TYPE_ID}");
            }
            else
            {
                Debug.LogError($"[MyMod] 物品注册失败: {ITEM_TYPE_ID}");
            }
        }

        // ============ 本地化 ============

        private void SetupLocalization()
        {
            UpdateLocalizationTexts();
            LocalizationManager.OnSetLanguage += OnLanguageChanged;
        }

        private void OnLanguageChanged(SystemLanguage language)
        {
            UpdateLocalizationTexts();
        }

        private void UpdateLocalizationTexts()
        {
            SystemLanguage lang = LocalizationManager.CurrentLanguage;

            switch (lang)
            {
                case SystemLanguage.English:
                    LocalizationManager.SetOverrideText(ITEM_NAME_KEY, "My Item");
                    LocalizationManager.SetOverrideText(ITEM_DESC_KEY, "Item description");
                    break;
                default:
                    LocalizationManager.SetOverrideText(ITEM_NAME_KEY, "我的物品");
                    LocalizationManager.SetOverrideText(ITEM_DESC_KEY, "物品描述文本");
                    break;
            }
        }

        // ============ 事件注册 ============

        private void RegisterGlobalEvents()
        {
            LevelManager.OnLevelInitialized += OnLevelReady;
            Item.onUseStatic += OnAnyItemUsed;
        }

        private void OnLevelReady()
        {
            player = LevelManager.Instance?.MainCharacter;
            if (player != null)
            {
                RegisterPlayerEvents();
            }
        }

        private void RegisterPlayerEvents()
        {
            if (eventsRegistered || player == null) return;

            player.OnShootEvent += OnPlayerShoot;
            player.OnAttackEvent += OnPlayerAttack;

            if (player.Health != null)
            {
                player.Health.OnHurtEvent.AddListener(OnPlayerHurt);
            }

            eventsRegistered = true;
        }

        private void UnregisterEvents()
        {
            // 全局事件
            LevelManager.OnLevelInitialized -= OnLevelReady;
            Item.onUseStatic -= OnAnyItemUsed;
            LocalizationManager.OnSetLanguage -= OnLanguageChanged;

            // 玩家事件
            if (eventsRegistered && player != null)
            {
                player.OnShootEvent -= OnPlayerShoot;
                player.OnAttackEvent -= OnPlayerAttack;
                player.Health?.OnHurtEvent.RemoveListener(OnPlayerHurt);
            }
        }

        // ============ 事件处理 ============

        private void OnAnyItemUsed(Item item, object user)
        {
            if (item.TypeID == ITEM_TYPE_ID)
            {
                Debug.Log("[MyMod] 玩家使用了我的物品!");
            }
        }

        private void OnPlayerShoot(DuckovItemAgent agent)
        {
            // 处理射击事件
        }

        private void OnPlayerAttack(DuckovItemAgent agent)
        {
            // 处理攻击事件
        }

        private void OnPlayerHurt(DamageInfo info)
        {
            // 处理受伤事件
        }

        // ============ 调试功能 ============

        private void HandleDebugKeys()
        {
            // F9: 给玩家添加测试物品
            if (Input.GetKeyDown(KeyCode.F9))
            {
                GiveItemToPlayer();
            }

            // F10: 显示调试信息
            if (Input.GetKeyDown(KeyCode.F10))
            {
                ShowDebugInfo();
            }
        }

        private void GiveItemToPlayer()
        {
            if (itemPrefab == null || player == null) return;

            Item newItem = itemPrefab.CreateInstance();
            if (newItem != null)
            {
                bool added = player.CharacterItem?.Inventory?.AddItem(newItem) ?? false;
                if (added)
                {
                    Debug.Log("[MyMod] 物品已添加到背包");
                }
                else
                {
                    Destroy(newItem.gameObject);
                    Debug.LogWarning("[MyMod] 无法添加物品到背包");
                }
            }
        }

        private void ShowDebugInfo()
        {
            if (player == null) return;

            string info = $"[MyMod 调试信息]\n" +
                $"HP: {player.Health?.CurrentHealth:F0}/{player.Health?.MaxHealth:F0}\n" +
                $"Stamina: {player.CurrentStamina:F0}/{player.MaxStamina:F0}\n" +
                $"Scene: {UnityEngine.SceneManagement.SceneManager.GetActiveScene().name}\n" +
                $"Position: {player.transform.position}";

            Debug.Log(info);
        }

        // ============ 工具方法 ============

        private void SetFieldValue(object obj, string fieldName, object value)
        {
            var type = obj.GetType();
            var field = type.GetField(fieldName,
                BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic);
            field?.SetValue(obj, value);
        }
    }
}
```

---

## 物品开发检查清单

### 基础配置

- [ ] TypeID 唯一且在 990000+ 范围内
- [ ] displayName 已设置（本地化键）
- [ ] description 已设置（本地化键）
- [ ] icon Sprite 已配置
- [ ] quality（品质）已设置
- [ ] value（价值）已设置

### 使用系统（如果可使用）

- [ ] UsageBehavior 组件已添加
- [ ] UsageBehavior 已加入 behaviors 列表
- [ ] CanBeUsed() 逻辑正确
- [ ] OnUse() 逻辑正确

### 显示系统

- [ ] ItemAgentUtilities 已配置（如需要）
- [ ] handheld Agent 预制体已设置（武器）
- [ ] pickup Agent 预制体已设置（掉落物）

### 效果系统（如果有效果）

- [ ] Effect 组件已添加
- [ ] 至少一个 Trigger
- [ ] 至少一个 Action
- [ ] Trigger 正确注册事件

### 注册系统

- [ ] ItemAssetsCollection.AddDynamicEntry() 调用成功
- [ ] 本地化文本已注册
- [ ] 商店条目已添加（如需要）

### 清理系统

- [ ] OnDestroy 中移除物品注册
- [ ] OnDestroy 中取消所有事件监听
- [ ] OnDestroy 中卸载 AssetBundle

---

## 事件注册检查清单

### 必须取消注册的事件

| 事件类型 | 注册方式 | 取消方式 |
|----------|----------|----------|
| 静态事件 | `+= handler` | `-= handler` |
| UnityEvent | `.AddListener()` | `.RemoveListener()` |
| IUpdatable | `Register(this)` | `Unregister(this)` |

### 常见需要清理的事件

```csharp
// 在 OnDestroy 中必须清理：
LevelManager.OnLevelInitialized -= OnLevelReady;
LevelManager.OnEvacuated -= OnEvacuated;
Item.onUseStatic -= OnAnyItemUsed;
LocalizationManager.OnSetLanguage -= OnLanguageChanged;

player.OnShootEvent -= OnPlayerShoot;
player.OnAttackEvent -= OnPlayerAttack;
player.Health?.OnHurtEvent.RemoveListener(OnPlayerHurt);
player.Health?.OnDeadEvent.RemoveListener(OnPlayerDead);

buffManager.onAddBuff -= OnBuffAdded;
buffManager.onRemoveBuff -= OnBuffRemoved;
```

---

## 常见错误排查

### 物品无法使用

```
检查清单：
├── UsageUtilities.behaviors 是否包含 UsageBehavior
├── UsageBehavior.CanBeUsed() 返回值
├── Item.Durability 是否足够
└── UsageUtilities.useDurability 和 durabilityUsage 配置
```

### 效果不触发

```
检查清单：
├── Effect.enabled 是否为 true
├── triggers 列表是否为空
├── Trigger 的 OnEnable 是否被调用
├── actions 列表是否为空
└── Filter 是否阻止了触发
```

### 物品无法获取

```
检查清单：
├── ItemAssetsCollection.AddDynamicEntry() 返回值
├── TypeID 是否与其他物品冲突
└── Prefab 是否正确加载
```

### 手持物品不显示

```
检查清单：
├── ItemAgentUtilities 是否配置
├── handheld Agent 预制体是否设置
└── AgentUtilities.Initialize() 是否调用
```

---

## TypeID 分配规范

| 范围 | 用途 |
|------|------|
| 1 - 9999 | 官方物品 |
| 10000 - 99999 | 预留 |
| 990000+ | Mod 物品（推荐） |

**重要**: TypeID 必须全局唯一，冲突会导致物品无法正常工作。

---

## 品质等级

| 品质值 | 名称 | 颜色 |
|--------|------|------|
| 0 | 普通 | 白色 |
| 1 | 优秀 | 绿色 |
| 2 | 精良 | 蓝色 |
| 3 | 稀有 | 紫色 |
| 4 | 史诗 | 橙色 |
| 5 | 传说 | 金色 |

---

## 调试快捷键建议

| 按键 | 功能 |
|------|------|
| F9 | 给玩家添加测试物品 |
| F10 | 显示调试信息 |
| F11 | 恢复玩家生命/体力 |
| F12 | 切换无敌模式 |

---

## 日志规范

```csharp
// 使用统一前缀
Debug.Log("[MyMod] 信息");
Debug.LogWarning("[MyMod] 警告");
Debug.LogError("[MyMod] 错误");

// 日志文件位置
// Windows: %USERPROFILE%\AppData\LocalLow\TeamSoda\Escape from Duckov\Player.log
// macOS: ~/Library/Logs/TeamSoda/Escape from Duckov/Player.log
```

---

## 最重要的原则

⚠️ **所有 `+=` 注册的事件，必须在 `OnDestroy()` 中用 `-=` 取消注册**

否则会导致：
1. 内存泄漏
2. Mod卸载后代码仍然执行
3. 空引用异常导致游戏崩溃
